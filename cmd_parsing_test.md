# 命令解析系统测试说明

## 系统架构

### 数据流
```
串口接收 → uart_rx_buffer → uart_parsing_buffer → cmd_parsing_task → protocol_parsing → switch-case → handler
```

### 核心模块
1. **uart_cmd.c**: 串口中断接收，触发命令解析事件
2. **cmd_parsing.c**: 命令解析核心，根据命令类型分发处理
3. **cmd_parsing.h**: 命令类型定义和接口声明

## 已实现的命令

### 系统控制类 (0x38 - 0x6F)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x38 | MSG_SINGLE_CLICK_TEST | 模拟单击事件 |
| 0x3A | MSG_SEND_TEST_DATA | 发送测试数据到从机 |
| 0x3B | MSG_DISCONNECT | 断开BLE连接并停止自动重连 |
| 0x3C | MSG_RECONNECT | 启动自动搜索和连接 |
| 0x6F | MSG_RESET_SYS | 系统复位 |

### 扫描控制类 (0x40 - 0x42)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x40 | MSG_START_SCAN | 开始扫描 |
| 0x41 | MSG_STOP_SCAN | 停止扫描 |
| 0x42 | MSG_SCAN_STATUS | 查询扫描状态 |

### 连接管理类 (0x50 - 0x52)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x50 | MSG_CONNECT_DEVICE | 连接指定设备 |
| 0x51 | MSG_DISCONNECT_DEVICE | 断开指定设备 |
| 0x52 | MSG_CONNECTION_STATUS | 查询连接状态 |

### 数据传输类 (0x60 - 0x61)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x60 | MSG_SEND_DATA | 发送数据到从机 |
| 0x61 | MSG_READ_DATA | 读取从机数据 |

### 配置类 (0x70 - 0x72)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x70 | MSG_SET_SCAN_PARAM | 设置扫描参数 |
| 0x71 | MSG_SET_CONN_PARAM | 设置连接参数 |
| 0x72 | MSG_GET_DEVICE_INFO | 获取设备信息 |

### 转发类 (0x80)
| 命令字节 | 命令名称 | 功能说明 |
|---------|---------|---------|
| 0x80 | MSG_FWD_TO_PERIPHERAL | 转发命令到从机 |

## 测试方法

### 1. 串口测试命令

使用串口工具发送以下十六进制命令：

#### 已实现功能测试
```
发送: 38 00 00 00 ...  # 模拟单击（已实现）
预期: 触发单击事件，ulog输出 "模拟单击事件"

发送: 3A 00 00 00 ...  # 发送测试数据（已实现）
预期: 启动发送测试数据，ulog输出 "启动发送测试数据"

发送: 3B 00 00 00 ...  # 断开连接（已实现）
预期: 断开BLE连接，ulog输出 "断开BLE连接并停止自动重连"

发送: 3C 00 00 00 ...  # 重新连接（已实现）
预期: 启动自动连接，ulog输出 "启动自动搜索和连接"

发送: 6F 00 00 00 ...  # 系统复位（已实现）
预期: 系统复位，ulog输出 "执行系统复位..."
```

#### 框架测试（打印分支）
```
发送: 40 00 00 00 ...  # 开始扫描
预期: ulog输出 "解析: MSG_START_SCAN" + "命令: 开始扫描"

发送: 41 00 00 00 ...  # 停止扫描
预期: ulog输出 "解析: MSG_STOP_SCAN" + "命令: 停止扫描"

发送: 50 00 00 00 ...  # 连接设备
预期: ulog输出 "解析: MSG_CONNECT_DEVICE" + "命令: 连接指定设备"

发送: 60 00 00 00 ...  # 发送数据
预期: ulog输出 "解析: MSG_SEND_DATA" + "命令: 发送数据到从机" + 数据HEX显示

发送: 70 00 00 00 ...  # 设置扫描参数
预期: ulog输出 "解析: MSG_SET_SCAN_PARAM" + "命令: 设置扫描参数"

发送: 80 00 00 00 ...  # 转发到从机
预期: ulog输出 "解析: MSG_FWD_TO_PERIPHERAL" + "命令: 转发到从机" + 数据HEX显示
```

#### 未知命令测试
```
发送: FF 00 00 00 ...  # 未知命令
预期: ulog输出 "未知命令类型: 0xFF" + HEX和DEC数据显示
```

### 2. 命令格式说明

所有命令都是 20 字节固定长度：

```
[0]    : 命令类型 (见上表)
[1]    : 保留
[2]    : 操作类型 (0=读取, 1=执行, 2=解析, 3=解析+保存)
[3-19] : 命令参数（根据具体命令而定）
```

### 3. 观察 ulog 输出

所有命令解析过程都会通过 ulog 打印：

```
utrace: "接收命令:" + HEX数据
uinfo:  "解析: MSG_xxx"
uinfo:  "命令: xxx功能描述"
udebug: "操作: 读取/执行/解析执行"
```

### 4. 测试步骤

1. **编译并烧录程序**
2. **打开串口工具**（波特率根据UART配置）
3. **发送测试命令**
4. **观察 ulog 输出**
5. **验证功能执行**

### 5. 扩展新命令

要添加新命令，需要：

1. 在 `cmd_parsing.h` 中添加命令枚举：
```c
MSG_YOUR_CMD = 0xXX,
```

2. 在 `cmd_parsing.c` 中添加处理函数：
```c
static void your_cmd_handler(uint8_t *data, uint16_t len)
{
    uinfo("命令: 你的命令功能\n");
    // TODO: 实现你的功能
}
```

3. 在 `protocol_parsing()` 的 switch-case 中添加分支：
```c
case MSG_YOUR_CMD:
    uinfo("解析: MSG_YOUR_CMD\n");
    parsing_cmd(cmd_parsing_buffer, NULL, your_cmd_handler, NULL);
    break;
```

## 注意事项

1. **缓冲区锁定机制**：`uart_parsing_buffer_LOCK` 防止数据覆盖
2. **命令长度固定**：所有命令都是 20 字节 (CMD_LEN)
3. **异步处理**：串口中断触发 TMOS 事件，由 cmd_parsing_task 处理
4. **ulog 日志**：所有解析过程都有日志输出，便于调试

## 移植说明

本命令解析系统是从 `BLE-HID-OTA` 从机项目移植而来，主要变化：

1. **简化数据源**：只保留 UART 和 BLE 两个数据源（去掉 HID 和 USB）
2. **中央设备定制**：命令类型针对中央设备的需求重新定义
3. **框架完整**：保留了从机的 parsing_cmd 三回调机制（report/parsing/save）
4. **可扩展性强**：新增命令只需要添加枚举、handler 和 case 分支

## 后续计划

1. ✅ 完成串口命令解析框架
2. ⏳ 实现 BLE 数据接收解析（从机反馈数据）
3. ⏳ 完善各命令的具体实现（目前只有打印）
4. ⏳ 添加命令应答机制（向PC回复执行结果）





